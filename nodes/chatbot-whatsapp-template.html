<script type="text/javascript">

  $.fn.RB_getWALocales = function() {
    return `<select name="code" style="width:32%;margin-left:2%;" placeholder="Choose a Language...">
      <option value="af">Afrikanns</option>
      <option value="sq">Albanian</option>
      <option value="ar">Arabic</option>
      <option value="az">Azerbaijani</option>
      <option value="bn">Bengali</option>
      <option value="bg">Bulgarian</option>
      <option value="ca">Catalan</option>
      <option value="zh_CN">Chinese (CHN)</option>
      <option value="zh_HK">Chinese (HKG)</option>
      <option value="zh_TW">Chinese (TAI)</option>
      <option value="hr">Croation</option>
      <option value="cs">Czech</option>
      <option value="da">Danish</option>
      <option value="nl">Dutch</option>
      <option value="en">English</option>
      <option value="en_GB">English UK</option>
      <option value="en_US">English US</option>
      <option value="et">Estonian</option>
      <option value="fil">Filipino</option>
      <option value="fi">Finnish</option>
      <option value="fr">French</option>
      <option value="ka">Georgian</option>
      <option value="de">German</option>
      <option value="el">Greek</option>
      <option value="gu">Gujarati</option>
      <option value="ha">Hausa</option>
      <option value="he">Hebrew</option>
      <option value="hi">Hindi</option>
      <option value="hu">Hungarian</option>
      <option value="id">Indonesian</option>
      <option value="ga">Irish</option>
      <option value="it">Italian</option>
      <option value="js">Japanese</option>
      <option value="ka">Kannada</option>
      <option value="kk">Kazakh</option>
      <option value="rw_RW">Kinyarwanda</option>
      <option value="ko">Korean</option>
      <option value="ky_KG">Kyrgyz (Kyrgyzstan)</option>
      <option value="lo">Lao</option>
      <option value="lv">Latvian</option>
      <option value="lt">Lithuanian</option>
      <option value="mk">Macedonian</option>
      <option value="ms">Malay</option>
      <option value="ml">Malayalam</option>
      <option value="mr">Marathi</option>
      <option value="no">Norwegian</option>
      <option value="fa">Persian</option>
      <option value="pl">Polish</option>
      <option value="pt_BR">Portuguese (BR)</option>
      <option value="pt_PT">Portuguese (POR)</option>
      <option value="pa">Punjabi</option>
      <option value="ro">Romanian</option>
      <option value="ru">Russian</option>
      <option value="sr">Serbian</option>
      <option value="sk">Slovak</option>
      <option value="sl">Slovenian</option>
      <option value="es">Spanish</option>
      <option value="es_AR">Spanish (ARG)</option>
      <option value="es_ES">Spanish (SPA)</option>
      <option value="es_MX">Spanish (MEX)</option>
      <option value="sw">Swahili</option>
      <option value="sv">Swedish</option>
      <option value="ta">Tamil</option>
      <option value="te">Telugu</option>
      <option value="th">Thai</option>
      <option value="tr">Turkish</option>
      <option value="uk">Ukranian</option>
      <option value="ur">Urdu</option>
      <option value="uz">Uzbek</option>
      <option value="vi">Vietnamese</option>
      <option value="zu">Zulu</option>
    </select>`;
  };

  $.fn.RB_getWhatsappTemplateParams = function(items) {
    params = [];
    var idx;
    for(idx = 0; idx < items.length; idx++) {
      var container = items[idx];
      var obj = {
        type: $('select[name=type]', container).val()
      };
      if (obj.type === 'text') {
        obj.text = $('input[name=text]', container).val();
      }
      if (obj.type === 'video') {
        obj.video = $('input[name=video]', container).val();
      }
      if (obj.type === 'image') {
        obj.image = $('input[name=image]', container).val();
      }
      if (obj.type === 'document') {
        obj.document = $('input[name=document]', container).val();
      }
      if (obj.type === 'date_time') {
        obj.date_time = {
          fallback_value: $('input[name=fallbackValue]', container).val()
        };
      }
      params.push(obj);
    }
    return params;
  };

  $.fn.RB_setWhatsappParams = function(item) {
    var container = $(this);
    if (item != null) {
      $('select[name=type]', container).val(item.type);
      $('.panel-' + item.type, container).css('display', 'inline-block');
      if (item.type === 'text') {
        $('input[name=text]', container).val(item.text);
      }
      if (item.type === 'video') {
        $('input[name=video]', container).val(item.video);
      }
      if (item.type === 'image') {
        $('input[name=image]', container).val(item.image);
      }
      if (item.type === 'document') {
        $('input[name=document]', container).val(item.document);
      }
      if (item.type === 'date_time') {
        $('input[name=fallbackValue]', container).val(item.date_time.fallback_value);
      }
      if (item.type === 'currency') {
        $('select[name=code]', container).val(item.code);
        $('input[name=amount_1000]', container).val(item.amount_1000);
        $('input[name=amount_1000]', container).val(item.amount_1000);
      }
    }
  };

  $.fn.RB_mountWhatsappParams = function(options) {
    options = options != null ? options : {};
    var container = $(this).css('paddingBottom', '5px');
    var main = $('<div style="display:inline-block;margin-right:10px;"/>').appendTo(container);
    var types = options.types ? options.types : ['currency', 'date_time', 'document', 'image', 'text', 'video'];
    var typesLabels = {
      currency: 'Cureency',
      date_time: 'Date-time',
      document: 'Document',
      image: 'Image',
      text: 'Text',
      video: 'Viceo'
    }
    var selectButtonType = $('<select name="type"></select>')
      .attr('style', 'width:100px; margin-left: 5px;')
      .attr('placeholder', 'Select parameter type')
      .change(function() {
        var type = $(this).val();
        $('.panel', container).hide();
        $('.panel-' + type, container).css('display', 'inline-block');
      })
      .appendTo(main);
    $('<option value="">Select type</option>').appendTo(selectButtonType);
    types.forEach(type => $('<option value="' + type + '">' + typesLabels[type] + '</option>').appendTo(selectButtonType));

    var panelText = $('<div class="panel panel-text" style="display:none;width:calc(100% - 120px);"/>').appendTo(container);
    $('<div/>')
      .append($('<input style="width:100%" type="text" name="text" placeholder="Text value"/>'))
      .appendTo(panelText);

    var panelImage = $('<div class="panel panel-image" style="display:none;width:calc(100% - 120px);"/>').appendTo(container);
    $('<div/>')
      .append($('<input style="width:100%" type="text" name="image" placeholder="Image URL or path"/>'))
      .appendTo(panelImage);

    var panelDocument = $('<div class="panel panel-document" style="display:none;width:calc(100% - 120px);"/>').appendTo(container);
    $('<div/>')
      .append($('<input style="width:100%" type="text" name="document" placeholder="Document URL or path"/>'))
      .appendTo(panelDocument);

    var panelCurrency = $('<div class="panel panel-currency" style="display:none;width:calc(100% - 120px);"/>').appendTo(container);
    $('<div/>')
      .append($('<input style="width:32%" type="text" name="amount_1000" placeholder="Amount x 1000"/>'))
      .append($.fn.RB_getWALocales())
      .append($('<input style="width:32%;margin-left:2%;" type="text" name="fallback_value" placeholder="Fallback"/>'))
      .appendTo(panelCurrency);

    var panelVideo = $('<div class="panel panel-video" style="display:none;width:calc(100% - 120px);"/>').appendTo(container);
    $('<div/>')
      .append($('<input style="width:100%" type="text" name="video" placeholder="Video URL or path"/>'))
      .appendTo(panelVideo);

    var panelText = $('<div class="panel panel-date_time" style="display:none;width:calc(100% - 120px);"/>').appendTo(container);
    $('<div/>')
      .append($('<input style="width:100%" type="text" name="fallbackValue" placeholder="Fallback value"/>'))
      .appendTo(panelText);
  };



  $.RedBot.registerType('chatbot-whatsapp-template', {
    category: $.RedBot.config.name,
    color: '#FFCC66',
    defaults: {
      name: {
        value: ''
      },
      language: {
        value: ''
      },
      template: {
        value: ''
      },
      paramsBody: {
        value: null
      },
      paramsHeader: {
        value: null
      }
    },
    inputs: 1,
    outputs: 1,
    icon: 'chatbot-sticker.png',
    paletteLabel: 'Whatsapp Template',
    label: function() {
      return this.name || 'Whatsapp Template';
    },
    oneditprepare: function() {
      // body
      $('#node-input-paramsBody-container')
        .css('min-width','450px')
        .css('min-height','100px')
        .editableList({
          addItem: function(container, i, item) {
            $(container).RB_mountWhatsappParams({
              types: ['currency', 'date_time', 'text']
            });
            $(container).RB_setWhatsappParams(item);
          },
          removable: true,
          sortable: true
        });
      if (this.paramsBody != null && this.paramsBody.length !== 0) {
        for (idx = 0; idx < this.paramsBody.length; idx++) {
          $('#node-input-paramsBody-container').editableList('addItem', this.paramsBody[idx]);
        }
      }
      // header
      $('#node-input-paramsHeader-container')
        .css('min-width','450px')
        .css('min-height','100px')
        .editableList({
          addItem: function(container, i, item) {
            $(container).RB_mountWhatsappParams();
            $(container).RB_setWhatsappParams(item);
          },
          removable: true,
          sortable: true
        });
      if (this.paramsHeader != null && this.paramsHeader.length !== 0) {
        for (idx = 0; idx < this.paramsBody.length; idx++) {
          $('#node-input-paramsHeader-container').editableList('addItem', this.paramsHeader[idx]);
        }
      }
    },
    oneditsave: function() {
      var items = $("#node-input-paramsBody-container").editableList('items');
      this.paramsBody = $.fn.RB_getWhatsappTemplateParams(items);
      var items = $("#node-input-paramsHeader-container").editableList('items');
      this.paramsHeader = $.fn.RB_getWhatsappTemplateParams(items);
    }
  });
</script>

<script type="text/x-red" data-template-name="chatbot-whatsapp-template">
<div class="form-row">
  <label for="node-input-name"><i class="icon-tag"></i> Name</label>
  <input type="text" id="node-input-name" placeholder="Name">
</div>
<div class="form-row">
  <label for="node-input-name">Template name</label>
  <input type="text" id="node-input-template" placeholder="my-template">
</div>
<div class="form-row">
  <label for="node-input-language">Language</label>
  <select id="node-input-language" placeholder="Choose a Language...">
    <option value="af">Afrikanns</option>
    <option value="sq">Albanian</option>
    <option value="ar">Arabic</option>
    <option value="az">Azerbaijani</option>
    <option value="bn">Bengali</option>
    <option value="bg">Bulgarian</option>
    <option value="ca">Catalan</option>
    <option value="zh_CN">Chinese (CHN)</option>
    <option value="zh_HK">Chinese (HKG)</option>
    <option value="zh_TW">Chinese (TAI)</option>
    <option value="hr">Croation</option>
    <option value="cs">Czech</option>
    <option value="da">Danish</option>
    <option value="nl">Dutch</option>
    <option value="en">English</option>
    <option value="en_GB">English UK</option>
    <option value="en_US">English US</option>
    <option value="et">Estonian</option>
    <option value="fil">Filipino</option>
    <option value="fi">Finnish</option>
    <option value="fr">French</option>
    <option value="ka">Georgian</option>
    <option value="de">German</option>
    <option value="el">Greek</option>
    <option value="gu">Gujarati</option>
    <option value="ha">Hausa</option>
    <option value="he">Hebrew</option>
    <option value="hi">Hindi</option>
    <option value="hu">Hungarian</option>
    <option value="id">Indonesian</option>
    <option value="ga">Irish</option>
    <option value="it">Italian</option>
    <option value="js">Japanese</option>
    <option value="ka">Kannada</option>
    <option value="kk">Kazakh</option>
    <option value="rw_RW">Kinyarwanda</option>
    <option value="ko">Korean</option>
    <option value="ky_KG">Kyrgyz (Kyrgyzstan)</option>
    <option value="lo">Lao</option>
    <option value="lv">Latvian</option>
    <option value="lt">Lithuanian</option>
    <option value="mk">Macedonian</option>
    <option value="ms">Malay</option>
    <option value="ml">Malayalam</option>
    <option value="mr">Marathi</option>
    <option value="no">Norwegian</option>
    <option value="fa">Persian</option>
    <option value="pl">Polish</option>
    <option value="pt_BR">Portuguese (BR)</option>
    <option value="pt_PT">Portuguese (POR)</option>
    <option value="pa">Punjabi</option>
    <option value="ro">Romanian</option>
    <option value="ru">Russian</option>
    <option value="sr">Serbian</option>
    <option value="sk">Slovak</option>
    <option value="sl">Slovenian</option>
    <option value="es">Spanish</option>
    <option value="es_AR">Spanish (ARG)</option>
    <option value="es_ES">Spanish (SPA)</option>
    <option value="es_MX">Spanish (MEX)</option>
    <option value="sw">Swahili</option>
    <option value="sv">Swedish</option>
    <option value="ta">Tamil</option>
    <option value="te">Telugu</option>
    <option value="th">Thai</option>
    <option value="tr">Turkish</option>
    <option value="uk">Ukranian</option>
    <option value="ur">Urdu</option>
    <option value="uz">Uzbek</option>
    <option value="vi">Vietnamese</option>
    <option value="zu">Zulu</option>
  </select>
</div>
<div class="form-row form-row-label" style="margin-bottom:0;">
  <label><i class="fa fa-list"></i> <span>Header parameters</span></label>
</div>
<div class="form-row node-input-rule-container-row" style="min-height:80px;">
  <ol id="node-input-paramsHeader-container"></ol>
</div>
<div class="form-row form-row-label" style="margin-bottom:0;">
  <label><i class="fa fa-list"></i> <span>Body parameters</span></label>
</div>
<div class="form-row node-input-rule-container-row" style="min-height:80px;">
  <ol id="node-input-paramsBody-container"></ol>
</div>
</script>

<script type="text/x-red" data-help-name="chatbot-whatsapp-template">
</script>
